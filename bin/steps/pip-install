#!/usr/bin/env bash

source $BIN_DIR/utils

export LIBRARY_PATH=${LIBRARY_PATH}:/app/.heroku/python/lib
export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:/app/.heroku/python/lib

# Horrible hack to remove static libraries so that
# the shared ones are used.
export $(dpkg-architecture -s|sed -e s/\;//g)
for LIB in libgmp libyaml ; do
  if [ -f /app/.apt/usr/lib/${DEB_HOST_GNU_TYPE}/${LIB}.so ] ; then
    rm -f /app/.apt/usr/lib/${DEB_HOST_GNU_TYPE}/${LIB}.a
  fi
done

# Install dependencies with Pip.
puts-step "Installing dependencies with pip"
echo "setting SWIG environment variables" | indent
export SWIG_FEATURES="\
-includeall \
-I/app/.apt/usr/include \
-I/app/.apt/usr/include/${DEB_HOST_GNU_TYPE} \
-I/usr/include/${DEB_HOST_GNU_TYPE} \
-I/app/.heroku/vendor/include \
-I$BUILD_DIR/.heroku/vendor/include \
-I/app/.heroku/python/include
-L/app/.apt/usr/lib \
-L/app/.apt/usr/lib/${DEB_HOST_GNU_TYPE} \
"
[ ! "$FRESH_PYTHON" ] && bpwatch start pip_install
[ "$FRESH_PYTHON" ] && bpwatch start pip_install_first

/app/.heroku/python/bin/pip install -r requirements.txt --exists-action=w --src=./.heroku/src --allow-all-external  | cleanup | indent

# Smart Requirements handling
cp requirements.txt .heroku/python/requirements-declared.txt
/app/.heroku/python/bin/pip freeze > .heroku/python/requirements-installed.txt

[ ! "$FRESH_PYTHON" ] && bpwatch stop pip_install
[ "$FRESH_PYTHON" ] && bpwatch stop pip_install_first

echo
